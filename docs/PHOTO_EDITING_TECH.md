# üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ
    ‚Üì
msg_photo() —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ ComfyUI/input
    ‚Üì
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 3 –∫–Ω–æ–ø–∫–∏ (FSM state machine)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ                  ‚îÇ                 ‚îÇ
‚ñº                 ‚ñº                  ‚ñº                 ‚ñº
‚ú® Enhance    ‚úèÔ∏è Edit prompt    üé≠ Edit + Mask
‚îÇ              ‚îÇ                  ‚îÇ
cb_photo_      msg_prompt         msg_photo_
actions()      (edit flow)        mask_router()
‚îÇ              ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
        _run_image_job()
        - Load workflow
        - Inject image
        - Inject mask (if)
        - Inject prompt
        - Queue to ComfyUI
              ‚îÇ
              ‚ñº
        client.wait_for_result()
        - resolve_outputs_simple()
        - download_file() with retry
              ‚îÇ
              ‚ñº
        _send_result_to_telegram()
        - answer_video/photo/document
        - retry 3 times
        - fallback save file locally
              ‚îÇ
              ‚ñº
        Result to User ‚úÖ
```

## Workflows

| –†–µ–∂–∏–º | Workflow | –í—Ä–µ–º—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|-------|---------|
| Enhance | sdxl_base_refiner (fallback: image_default) | 30-60s | –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ |
| Edit | image_default | 60-120s | Img2img —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è |
| Mask | image_default | 120-180s | Inpaint —Å –º–∞—Å–∫–æ–π |

## –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### `msg_photo()`
- –ü–æ–ª—É—á–∞–µ—Ç —Ñ–æ—Ç–æ –æ—Ç Telegram
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ tmp –∏ ComfyUI/input
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 3 –∫–Ω–æ–ø–∫–∏ —Å –ø–æ–º–æ—â—å—é `_photo_actions_kb()`

### `cb_photo_actions()`
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º:
- **Enhance**: –ó–∞–ø—É—Å–∫–∞–µ—Ç `_run_image_job()` —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
- **Edit**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ `edit_prompt`, –∂–¥—ë—Ç —Ç–µ–∫—Å—Ç–∞
- **Mask**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ `edit_mask_wait_mask`, –∂–¥—ë—Ç –º–∞—Å–∫–∏

### `msg_prompt()` - Edit Flow
–ï—Å–ª–∏ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `edit_prompt` –∏–ª–∏ `edit_mask_prompt`:
- –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—ã–∑—ã–≤–∞–µ—Ç `_run_image_job()` —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º —Ñ–æ—Ç–æ –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –º–∞—Å–∫–æ–π
- –ü–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è

### `msg_photo_mask_router()`
–í—Ç–æ—Ä–æ–π handler –¥–ª—è F.photo:
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ = `edit_mask_wait_mask`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∞—Å–∫—É –≤ ComfyUI/input
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `edit_mask_prompt`, –∂–¥—ë—Ç –ø—Ä–æ–º–ø—Ç–∞

### `_run_image_job()`
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π runner –¥–ª—è –≤—Å–µ—Ö image –æ–ø–µ—Ä–∞—Ü–∏–π:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç workflow
- –ò–Ω–∂–µ–∫—Ç–∏—Ç –≤—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ
- –ò–Ω–∂–µ–∫—Ç–∏—Ç –º–∞—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ workflow –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
- –ò–Ω–∂–µ–∫—Ç–∏—Ç –ø—Ä–æ–º–ø—Ç –∏ negative prompt
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ ComfyUI
- –ñ–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram —á–µ—Ä–µ–∑ `_send_result_to_telegram()`

### `_send_result_to_telegram()`
–ù–∞–¥—ë–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø (video/photo/document)
- –ü—Ä–æ–±—É–µ—Ç `answer_video()` ‚Üí `answer_photo()` ‚Üí `answer_document()`
- 3 –ø–æ–ø—ã—Ç–∫–∏ —Å 2 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–æ–π
- Fallback: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç—å

### `resolve_outputs_simple()` (–≤ client.py)
–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è output:
- –ò—â–µ—Ç **–ø–µ—Ä–≤—ã–π** —Ñ–∞–π–ª –≤ **–ª—é–±–æ–º** —É–∑–ª–µ outputs
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã workflow
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: node_id, filename, type

## FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ

```
Initial: No photo
    ‚Üì
msg_photo() ‚Üí last_photo_comfy = filename
    ‚Üì
Show buttons ‚Üí Click one

Edit prompt path:
‚îú‚îÄ pending_photo_action = "edit_prompt"
‚îú‚îÄ –∂–¥—ë–º —Ç–µ–∫—Å—Ç–∞ –≤ msg_prompt()
‚îú‚îÄ msg_prompt() –∑–∞–ø—É—Å–∫–∞–µ—Ç job
‚îî‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

Edit mask path:
‚îú‚îÄ pending_photo_action = "edit_mask_wait_mask"
‚îú‚îÄ –∂–¥—ë–º —Ñ–æ—Ç–æ –≤ msg_photo_mask_router()
‚îú‚îÄ mask_photo_comfy = mask_filename
‚îú‚îÄ pending_photo_action = "edit_mask_prompt"
‚îú‚îÄ –∂–¥—ë–º —Ç–µ–∫—Å—Ç–∞ –≤ msg_prompt()
‚îú‚îÄ msg_prompt() –∑–∞–ø—É—Å–∫–∞–µ—Ç job —Å –º–∞—Å–∫–æ–π
‚îî‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç
```

## –ò–Ω–∂–µ–∫—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

`_inject_prompt(workflow, prompt, negative_prompt="")`

- –ò—â–µ—Ç –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–æ–¥—ã –≤ workflow
- –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç positive –≤ positive –Ω–æ–¥—ã, negative –≤ negative –Ω–æ–¥—ã
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–ª—é—á–∏: text, prompt, positive, clip_text –∏ —Ç.–¥.

–î–ª—è edit —Ä–µ–∂–∏–º–æ–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å:
```python
prompt = f"{user_text}. Keep the same subject identity and scene layout, realistic, natural light, coherent details."
```

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–ø–∏—Ç–±—É–ª—å –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ –±–æ–ª–æ–Ω–∫—É" –ø—Ä–æ–±–ª–µ–º—É.

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ú—è–≥–∫–∏–µ –æ—à–∏–±–∫–∏ (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º)
- –ú–∞—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ workflow ‚Üí –ª–æ–≥–∏—Ä—É–µ–º warning, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –±–µ–∑ –º–∞—Å–∫–∏
- SDXL –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º image_default
- –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –Ω–µ —É–¥–∞–ª–∞—Å—å ‚Üí –ø–æ–≤—Ç–æ—Ä—è–µ–º

### –ñ—ë—Å—Ç–∫–∏–µ –æ—à–∏–±–∫–∏ (–ø–∞–¥–∞–µ–º —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
- Workflow –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí RuntimeError
- –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Üí RuntimeError
- 3 –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –Ω–µ—É–¥–∞—á–Ω—ã ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:

```
# –£—Å–ø–µ—à–Ω—ã–µ –ø—É—Ç–∏:
"‚úì inject node=XX" - –ø—Ä–æ–º–ø—Ç –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω
"Image result: filename=... size=..." - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤
"Telegram send: photo/video/document" - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram

# –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø—É—Ç–∏:
"Mask mode requested but no mask inputs found" - –º–∞—Å–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∞
"failed attempt=X" - Telegram –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
"Timeout waiting for result" - ComfyUI –±—ã–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–º
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 8GB VRAM

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è | –£–∑–∫–æ–µ –º–µ—Å—Ç–æ |
|----------|-------|------------|
| Enhance (SDXL) | 30-60s | Inference SDXL |
| Edit (img2img) | 60-120s | Inference –º–æ–¥–µ–ª–∏ |
| Edit (mask) | 120-180s | Inpaint inference |
| Telegram send | 5-15s | –°–µ—Ç—å |
| **–ò—Ç–æ–≥–æ enhance** | 40-80s | –í—Å—ë |
| **–ò—Ç–æ–≥–æ edit** | 70-200s | –í—Å—ë |

---

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: —Å–º. PHOTO_EDITING.md
